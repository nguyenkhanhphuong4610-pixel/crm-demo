<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Spa CRM ‚Äì Advanced Showcase</title>

<style>
body{font-family:Arial;background:#f4f6f8;padding:20px}
.container{max-width:1300px;margin:auto}
h1{text-align:center;color:#e91e63}
.card{background:#fff;padding:15px;border-radius:10px;margin-bottom:20px}
input,select,textarea,button{width:100%;padding:8px;margin-top:6px}
button{background:#e91e63;color:#fff;border:none;border-radius:6px;cursor:pointer}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ddd;padding:8px;text-align:center;font-size:14px}
th{background:#fde4ec}
textarea{height:70px}
.badge{padding:4px 8px;border-radius:5px;color:#fff;font-size:12px}
.doing{background:#ff9800}
.done{background:#4caf50}
.alert{background:#fff3cd;padding:10px;border-radius:6px;margin-bottom:15px}
.search{display:flex;gap:10px}

/* MODAL */
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;
background:rgba(0,0,0,.5)}
.modal-content{
background:#fff;width:80%;max-width:900px;
margin:40px auto;padding:20px;border-radius:10px;
max-height:90%;overflow:auto
}
.close{float:right;font-size:20px;cursor:pointer}
img.preview{max-width:45%;border-radius:6px;border:1px solid #ddd;margin:5px}
.flex{display:flex;gap:10px;flex-wrap:wrap}
</style>
</head>

<body>
<div class="container">
<h1>üå∏ Spa CRM ‚Äì Advanced Demo</h1>

<div id="birthdayAlert"></div>

<!-- FORM -->
<div class="card">
<h3>Th√™m / S·ª≠a kh√°ch h√†ng</h3>

<input id="customerName" placeholder="T√™n kh√°ch h√†ng">
<input id="phone" placeholder="S·ªë ƒëi·ªán tho·∫°i">
<input type="date" id="birthday">
<input id="service" placeholder="D·ªãch v·ª• s·ª≠ d·ª•ng">
<input type="number" id="price" placeholder="Gi√° d·ªãch v·ª• (VNƒê)">
<input id="consultant" placeholder="Nh√¢n vi√™n t∆∞ v·∫•n">
<input id="staff" placeholder="Nh√¢n vi√™n chƒÉm s√≥c">
<input type="date" id="nextDate">

<select id="status">
<option value="doing">ƒêang trong ti·∫øn tr√¨nh</option>
<option value="done">ƒê√£ ho√†n th√†nh</option>
</select>

<textarea id="roadmap" placeholder="L·ªô tr√¨nh (m·ªói d√≤ng = 1 bu·ªïi)"></textarea>

<label>·∫¢nh Before</label>
<input type="file" id="beforeImg" accept="image/*">

<label>·∫¢nh After</label>
<input type="file" id="afterImg" accept="image/*">

<button onclick="saveCustomer()">L∆∞u kh√°ch h√†ng</button>
</div>

<!-- SEARCH -->
<div class="card">
<h3>üîç T√¨m ki·∫øm kh√°ch h√†ng</h3>
<input id="search" placeholder="Nh·∫≠p t√™n ho·∫∑c s·ªë ƒëi·ªán tho·∫°i" oninput="render()">
</div>

<!-- STATS -->
<div class="card">
<h3>üìä Th·ªëng k√™</h3>
<p><b>T·ªïng kh√°ch:</b> <span id="totalCus">0</span></p>
<p><b>T·ªïng doanh thu:</b> <span id="totalMoney">0</span> ƒë</p>
</div>

<!-- LIST -->
<div class="card">
<h3>Danh s√°ch kh√°ch h√†ng</h3>
<table>
<thead>
<tr>
<th>T√™n</th>
<th>SƒêT</th>
<th>D·ªãch v·ª•</th>
<th>Gi√°</th>
<th>Tr·∫°ng th√°i</th>
<th>H·∫πn</th>
<th>M·ªü</th>
<th>S·ª≠a</th>
</tr>
</thead>
<tbody id="list"></tbody>
</table>
</div>
</div>

<!-- MODAL TAB -->
<div class="modal" id="modal">
<div class="modal-content">
<span class="close" onclick="closeModal()">‚úñ</span>
<div id="modalBody"></div>
</div>
</div>

<script>
let customers = JSON.parse(localStorage.getItem("spaCRM")) || [];
let editingId = null;

function toBase64(file, cb){
  if(!file){cb("");return;}
  const r=new FileReader();
  r.onload=e=>cb(e.target.result);
  r.readAsDataURL(file);
}

function saveCustomer(){
  toBase64(beforeImg.files[0], before=>{
    toBase64(afterImg.files[0], after=>{
      const data={
        id: editingId||Date.now(),
        name:customerName.value.trim(),
        phone:phone.value.trim(),
        birthday:birthday.value,
        service:service.value,
        price:+price.value||0,
        consultant:consultant.value,
        staff:staff.value,
        status:status.value,
        nextDate:nextDate.value,
        roadmap:roadmap.value?roadmap.value.split("\n"):[],
        beforeImg:before,
        afterImg:after
      };
      if(!data.name||!data.phone){alert("Nh·∫≠p t√™n v√† SƒêT");return;}
      editingId
        ? customers=customers.map(c=>c.id===editingId?data:c)
        : customers.push(data);
      editingId=null;
      localStorage.setItem("spaCRM",JSON.stringify(customers));
      clearForm(); render();
    });
  });
}

function render(){
  list.innerHTML="";
  let total=0;
  const key=search.value.toLowerCase();
  customers
    .filter(c=>c.name.toLowerCase().includes(key)||c.phone.includes(key))
    .forEach(c=>{
      total+=c.price;
      list.innerHTML+=`
      <tr>
        <td>${c.name}</td>
        <td>${c.phone}</td>
        <td>${c.service}</td>
        <td>${c.price.toLocaleString()}ƒë</td>
        <td><span class="badge ${c.status}">${c.status=="doing"?"ƒêang l√†m":"Xong"}</span></td>
        <td>${c.nextDate||"-"}</td>
        <td><button onclick="openTab(${c.id})">M·ªü</button></td>
        <td><button onclick="editCustomer(${c.id})">S·ª≠a</button></td>
      </tr>`;
    });
  totalCus.innerText=customers.length;
  totalMoney.innerText=total.toLocaleString();
  birthdayCheck();
}

function openTab(id){
  const c=customers.find(x=>x.id===id);
  modalBody.innerHTML=`
  <h3>${c.name}</h3>
  <p><b>SƒêT:</b> ${c.phone}</p>
  <p><b>D·ªãch v·ª•:</b> ${c.service}</p>
  <p><b>NV t∆∞ v·∫•n:</b> ${c.consultant}</p>
  <p><b>NV chƒÉm s√≥c:</b> ${c.staff}</p>
  <p><b>L·ªô tr√¨nh:</b></p>
  <ul>${c.roadmap.map(r=>`<li>${r}</li>`).join("")}</ul>
  <h4>Before / After</h4>
  <div class="flex">
    ${c.beforeImg?`<img src="${c.beforeImg}" class="preview">`:""}
    ${c.afterImg?`<img src="${c.afterImg}" class="preview">`:""}
  </div>`;
  modal.style.display="block";
}

function closeModal(){modal.style.display="none"}

function editCustomer(id){
  const c=customers.find(x=>x.id===id);
  editingId=id;
  customerName.value=c.name;
  phone.value=c.phone;
  birthday.value=c.birthday;
  service.value=c.service;
  price.value=c.price;
  consultant.value=c.consultant;
  staff.value=c.staff;
  status.value=c.status;
  nextDate.value=c.nextDate;
  roadmap.value=c.roadmap.join("\n");
  window.scrollTo(0,0);
}

function clearForm(){
  customerName.value=phone.value=birthday.value=service.value=price.value=
  consultant.value=staff.value=nextDate.value=roadmap.value="";
  beforeImg.value=afterImg.value="";
  status.value="doing";
}

function birthdayCheck(){
  const today=new Date().toISOString().slice(5,10);
  const listBD=customers.filter(c=>c.birthday?.slice(5,10)===today);
  birthdayAlert.innerHTML=listBD.length
    ? `<div class="alert">üéÇ H√¥m nay sinh nh·∫≠t: ${listBD.map(c=>c.name).join(", ")}</div>`
    : "";
}

render();
</script>
</body>
</html>