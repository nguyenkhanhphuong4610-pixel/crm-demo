<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Spa CRM â€“ Final Demo</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{font-family:Arial;background:#f2f4f7;padding:20px}
.card{background:#fff;padding:16px;border-radius:10px;margin-bottom:16px}
input,textarea,button{width:100%;padding:8px;margin-top:6px}
button{background:#e91e63;color:#fff;border:none;border-radius:6px}
.hidden{display:none}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ddd;padding:8px;text-align:center}
a{color:#e91e63;cursor:pointer}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginPage" class="card">
<h2>ğŸ” ÄÄƒng nháº­p</h2>
<input id="username" placeholder="TÃªn Ä‘Äƒng nháº­p">
<input id="password" type="password" placeholder="Máº­t kháº©u">
<button onclick="login()">Login</button>
<p style="color:#888">TÃ i khoáº£n máº·c Ä‘á»‹nh: admin / 123456</p>
</div>

<!-- APP -->
<div id="app" class="hidden">

<div class="card">
<button onclick="logout()">ÄÄƒng xuáº¥t</button>
<button onclick="backup()">â¬‡ Backup dá»¯ liá»‡u</button>
<input type="file" onchange="restore(this)">
</div>

<div class="card">
<h3>â• ThÃªm khÃ¡ch</h3>
<input id="customerName" placeholder="TÃªn khÃ¡ch">
<input id="phone" placeholder="SÄT">
<textarea id="roadmap" placeholder="Lá»™ trÃ¬nh (má»—i dÃ²ng 1 bÆ°á»›c)"></textarea>
<input id="beforeImg" placeholder="Link áº£nh Before">
<input id="afterImg" placeholder="Link áº£nh After">
<button onclick="addCustomer()">LÆ°u</button>
</div>

<div class="card">
<table>
<thead><tr><th>TÃªn</th><th>SÄT</th><th>Há»“ sÆ¡</th></tr></thead>
<tbody id="list"></tbody>
</table>
</div>

</div>

<script>
/* ================= FIREBASE ================= */
const firebaseConfig = {
  apiKey: "DÃN_Cá»¦A_Báº N",
  authDomain: "DÃN_Cá»¦A_Báº N",
  projectId: "DÃN_Cá»¦A_Báº N"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ================= SHA-256 ================= */
async function sha256(text){
  const data = new TextEncoder().encode(text);
  const hash = await crypto.subtle.digest("SHA-256", data);
  return Array.from(new Uint8Array(hash))
    .map(b=>b.toString(16).padStart(2,"0")).join("");
}

/* ================= AUTH ================= */
async function login(){
  try{
    const u = username.value;
    const p = password.value;
    const hash = await sha256(p);

    const snap = await db.collection("users")
      .where("username","==",u).get();

    if(snap.empty){ alert("Sai tÃ i khoáº£n"); return; }

    const user = snap.docs[0].data();
    if(user.passwordHash !== hash){
      alert("Sai máº­t kháº©u"); return;
    }

    localStorage.isLogin="true";
    loginPage.classList.add("hidden");
    app.classList.remove("hidden");
    loadCustomers();

  }catch(e){
    alert("Lá»—i Ä‘Äƒng nháº­p: " + e.message);
  }
}

function logout(){
  localStorage.clear();
  location.reload();
}

/* ================= CRM ================= */
async function addCustomer(){
  if(!customerName.value || !phone.value){
    alert("Thiáº¿u tÃªn hoáº·c SÄT"); return;
  }
  await db.collection("customers").add({
    name:customerName.value,
    phone:phone.value,
    roadmap:roadmap.value.split("\n"),
    beforeImg:beforeImg.value,
    afterImg:afterImg.value
  });
  loadCustomers();
}

async function loadCustomers(){
  list.innerHTML="";
  const snap = await db.collection("customers").get();
  snap.forEach(doc=>{
    const c=doc.data();
    list.innerHTML+=`
      <tr>
        <td>${c.name}</td>
        <td>${c.phone}</td>
        <td><a onclick="alert('Trang há»“ sÆ¡ cÃ³ thá»ƒ tÃ¡ch riÃªng tiáº¿p')">Má»Ÿ</a></td>
      </tr>`;
  });
}

/* ================= BACKUP ================= */
async function backup(){
  const snap = await db.collection("customers").get();
  const data=[];
  snap.forEach(d=>data.push(d.data()));
  const blob=new Blob([JSON.stringify(data)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="spa-backup.json";
  a.click();
}

/* ================= RESTORE ================= */
function restore(input){
  const reader=new FileReader();
  reader.onload=async e=>{
    const data=JSON.parse(e.target.result);
    for(const c of data){
      await db.collection("customers").add(c);
    }
    loadCustomers();
  };
  reader.readAsText(input.files[0]);
}

/* ================= AUTO LOGIN ================= */
if(localStorage.isLogin==="true"){
  loginPage.classList.add("hidden");
  app.classList.remove("hidden");
  loadCustomers();
}
</script>

</body>
</html>